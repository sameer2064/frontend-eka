<!DOCTYPE html>
<html>
<head>
  <title>Eka Racing</title>
  <meta charset="utfâ€‘8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Russo+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* ... include all your original styles unchanged ... */
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="gameUI"> ... </div>
    <div id="loadingScreen"> ... </div>
    <div id="gameOverScreen"> ... </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <script>
  // ===== CONFIG & STATE =====
  const config = { /* same as yours */ };
  const gameState = {
    score:0, level:1, speed:0, maxSpeed: config.car.maxSpeed,
    obstacleInterval: config.game.obstacleInterval,
    carX: window.innerWidth / 2,
    coins:[], obstacles:[], effects:[],
    lastCoinTime: 0, lastObstacleTime: 0,
    gameActive:false, loading:true, nitroActive:false, nitroTimeout:null,
    keys:{ ArrowLeft:false, ArrowRight:false, ArrowUp:false, ArrowDown:false }
  };

  // ===== PIXI SETUP =====
  const app = new PIXI.Application({
    view: document.getElementById("gameCanvas"),
    width:window.innerWidth, height:window.innerHeight,
    backgroundColor:0x111111, antialias:true,
    resolution: window.devicePixelRatio || 1,
    autoDensity: true
  });
  window.addEventListener('resize', ()=>{
    app.renderer.resize(window.innerWidth, window.innerHeight);
  });

  // ===== ROAD & MARKINGS =====
  const road = new PIXI.Graphics();
  road.beginFill(0x333333);
  road.moveTo(window.innerWidth*0.2,0);
  road.lineTo(window.innerWidth*0.8,0);
  road.lineTo(window.innerWidth*0.85, window.innerHeight);
  road.lineTo(window.innerWidth*0.15, window.innerHeight);
  road.closePath(); road.endFill();
  app.stage.addChild(road);

  const roadMarkings = [];
  for(let i=0;i<20;i++){
    const m = new PIXI.Graphics();
    m.beginFill(0xFFFFFF,0.8);
    m.drawRect(-4,-20,8,40);
    m.endFill();
    m.x = window.innerWidth/2;
    m.y = i*40-40;
    app.stage.addChild(m);
    roadMarkings.push(m);
  }

  // ===== CAR SETUP =====
  const car = new PIXI.Container();
  const carBody = new PIXI.Graphics();
  carBody.beginFill(0x0066FF);
  carBody.drawRoundedRect(-35,-60,70,120,20);
  carBody.endFill();
  // add windows, headlights, taillights (same as yours)
  car.addChild(carBody);
  const createWheel=(x,y)=>{
    const w=new PIXI.Graphics();
    w.beginFill(0x222);
    w.drawCircle(0,0,15);
    w.endFill();
    w.beginFill(0x444);
    w.drawCircle(0,0,10);
    w.endFill();
    w.position.set(x,y); return w;
  };
  car.addChild(createWheel(-25,40),createWheel(25,40),createWheel(-25,-30),createWheel(25,-30));
  const nitroEffect = new PIXI.Graphics();
  nitroEffect.beginFill(0x00FFFF,0.7);
  nitroEffect.drawRect(-25,60,50,30);
  nitroEffect.endFill();
  nitroEffect.visible=false;
  car.addChild(nitroEffect);
  car.x=gameState.carX; car.y=window.innerHeight*0.8;
  app.stage.addChild(car);

  // ===== SOUNDS =====
  const sounds = {
    engine: new Howl({src:['https://assets.codepen.io/21542/engine-sound.mp3'],loop:true,volume:0.3}),
    nitro: new Howl({src:['https://assets.codepen.io/21542/nitro-sound.mp3'],volume:0.5}),
    crash: new Howl({src:['https://assets.codepen.io/21542/crash-sound.mp3'],volume:0.7}),
    coin: new Howl({src:['https://assets.codepen.io/21542/coin-sound.mp3'],volume:0.4}),
  };

  // ===== SPAWNER, COLLISION, EFFECTS, LEVEL-UP =====
  // Copy your implementations for createCoin, createObstacle, checkCollisions, checkLevelUp, createEffect, etc.
  // Just ensure obstacleInterval and lastObstacleTime are initialized/reset properly.

  // ===== MOVEMENT & NITRO FUNCTIONS =====
  function moveLeft(){ gameState.carX=Math.max(config.car.laneBounds.left, gameState.carX-8); car.x=gameState.carX;}
  function moveRight(){ gameState.carX=Math.min(config.car.laneBounds.right, gameState.carX+8); car.x=gameState.carX;}
  function accelerate(){
    if(gameState.nitroActive){
      gameState.speed=Math.min(gameState.maxSpeed*config.car.nitroBoost, gameState.speed+config.car.acceleration*2);
    } else {
      gameState.speed=Math.min(gameState.maxSpeed, gameState.speed+config.car.acceleration);
    }
  }
  function brake(){
    gameState.speed=Math.max(config.car.minSpeed, gameState.speed-config.car.deceleration);
    deactivateNitro();
  }
  function activateNitro(){
    if(gameState.speed > gameState.maxSpeed*0.7 && !gameState.nitroActive){
      gameState.nitroActive = true;
      sounds.nitro.play();
      nitroEffect.visible = true;
      clearTimeout(gameState.nitroTimeout);
      gameState.nitroTimeout = setTimeout(deactivateNitro, config.car.nitroDuration);
    }
  }
  function deactivateNitro(){
    gameState.nitroActive = false;
    nitroEffect.visible = false;
    clearTimeout(gameState.nitroTimeout);
    gameState.nitroTimeout = null;
  }

  // ===== UPDATE UI =====
  function updateScoreDisplay(){document.getElementById('scoreDisplay').textContent=gameState.score;}
  function updateLevelDisplay(){document.getElementById('levelDisplay').textContent=gameState.level;}
  function updateSpeedDisplay(){document.getElementById('speedDisplay').textContent=Math.floor(gameState.speed*config.ui.speedMultiplier);}

  // ===== GAME LOOP =====
  function gameLoop(delta){
    if(!gameState.gameActive) return;

    if(gameState.keys.ArrowLeft) moveLeft();
    if(gameState.keys.ArrowRight) moveRight();
    if(gameState.keys.ArrowUp) accelerate();
    if(gameState.keys.ArrowDown) brake();

    nitroEffect.visible=gameState.nitroActive;
    if(gameState.nitroActive){
      nitroEffect.clear();
      nitroEffect.beginFill(0x00FFFF,0.6 - Math.random()*0.2);
      nitroEffect.drawRect(-25 - Math.random()*10,60,50 + Math.random()*20,30 + Math.random()*20);
      nitroEffect.endFill();
    }

    roadMarkings.forEach(m=>{
      m.y += gameState.speed;
      if(m.y > window.innerHeight) m.y = -40;
      const scale = 0.6 + (m.y / window.innerHeight)*0.4;
      m.scale.set(scale);
    });

    createCoin(); createObstacle();

    gameState.coins.forEach((coin,i)=>{
      coin.y += gameState.speed;
      coin.sprite.y = coin.y;
      coin.update && coin.update();
      if(coin.y > window.innerHeight + 50){
        app.stage.removeChild(coin.sprite);
        gameState.coins.splice(i,1);
      }
    });

    gameState.obstacles.forEach((obs,i)=>{
      obs.y += gameState.speed;
      obs.sprite.y = obs.y;
      if(obs.y > window.innerHeight + obs.height){
        app.stage.removeChild(obs.sprite);
        gameState.obstacles.splice(i,1);
      }
    });

    checkCollisions();
    gameState.effects.forEach((eff,i)=>{
      eff.alpha -= 0.02;
      eff.sprite.alpha = eff.alpha;
      eff.sprite.scale.x *= 0.98;
      eff.sprite.scale.y *= 0.98;
      if(eff.alpha <= 0){
        app.stage.removeChild(eff.sprite);
        gameState.effects.splice(i,1);
      }
    });

    updateSpeedDisplay();
  }

  // ===== GAME START / RESET =====
  function resetGame(){
    gameState.coins.forEach(c=>app.stage.removeChild(c.sprite));
    gameState.obstacles.forEach(o=>app.stage.removeChild(o.sprite));
    gameState.effects.forEach(e=>app.stage.removeChild(e.sprite));

    Object.assign(gameState,{
      score:0, speed:0, maxSpeed: config.car.maxSpeed,
      carX: window.innerWidth/2, coins:[], obstacles:[], effects:[],
      level:1, scoreToNextLevel:config.game.baseLevelScore,
      obstacleInterval: config.game.obstacleInterval,
      gameActive:true, nitroActive:false
    });
    clearTimeout(gameState.nitroTimeout);
    updateScoreDisplay(); updateLevelDisplay(); updateSpeedDisplay();
    car.x = gameState.carX;
    document.getElementById('gameOverScreen').style.display = 'none';
    sounds.engine.play();
  }

  function gameOver(){
    gameState.gameActive = false;
    sounds.engine.stop(); sounds.crash.play();
    document.getElementById('finalScore').textContent = `Your Score: ${gameState.score}`;
    document.getElementById('gameOverScreen').style.display = 'flex';
    for(let i=0;i<30;i++){
      createEffect(car.x + (Math.random()*60-30), car.y + (Math.random()*60-30), 0xFF3333, Math.random()*20+10);
    }
  }

  function startGame(){
    document.getElementById('loadingScreen').style.display='none';
    gameState.loading = false;
    gameState.gameActive = true;
    updateScoreDisplay(); updateLevelDisplay(); updateSpeedDisplay();
    sounds.engine.play();
    app.ticker.add(gameLoop);
  }

  setTimeout(startGame, 2000);

  // ===== KEY & TOUCH BINDINGS =====
  window.addEventListener('keydown', e=>{
    if(!gameState.gameActive) return;
    if(e.key in gameState.keys) gameState.keys[e.key] = true;
    if(e.key === ' ') activateNitro();
  });
  window.addEventListener('keyup', e=>{
    if(e.key in gameState.keys) gameState.keys[e.key] = false;
  });

  ['leftBtn','rightBtn','acceleratorBtn','brakeBtn'].forEach(btnId=>{
    const mapping = {
      leftBtn: 'ArrowLeft', rightBtn: 'ArrowRight',
      acceleratorBtn: 'ArrowUp', brakeBtn: 'ArrowDown'
    }[btnId];
    const btn = document.getElementById(btnId);
    btn.addEventListener('pointerdown', e=>{
      gameState.keys[mapping] = true;
      if(btnId==='acceleratorBtn'){
        const now = performance.now();
        if(now - (btn.lastTap||0) < 300) activateNitro();
        btn.lastTap = now;
      }
    });
    btn.addEventListener('pointerup', e=>{
      gameState.keys[mapping] = false;
    });
    btn.addEventListener('pointerleave', e=>{
      gameState.keys[mapping] = false;
    });
  });

  document.getElementById('exitBtn').addEventListener('click',()=>{
    window.location.href='index.html';
  });
  document.getElementById('restartBtn').addEventListener('click', resetGame);
  document.getElementById('menuBtn').addEventListener('click', ()=> window.location.href='index.html');

  </script>
</body>
</html>
